<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Simulador de Corrida - ViaSimples</title>
  <link rel="stylesheet" href="style-viasimples.css?v=1.0.1" />
</head>

<body>
  <main class="container">
    <h1>Simule sua corrida</h1>

    <form id="formSimulador" onsubmit="event.preventDefault(); calcularCorrida();" novalidate>
      <label for="nomePassageiro">üë§ Seu nome completo:</label>
      <input type="text" id="nomePassageiro" name="nomePassageiro" required autocomplete="name" placeholder="Ex: Wagner Oliveira" />

      <label for="origem">üìç Local de partida:</label>
      <input type="text" id="origem" name="origem" autocomplete="off" placeholder="Digite ou use localiza√ß√£o atual" />

      <label for="destino">üéØ Destino final:</label>
      <input type="text" id="destino" name="destino" required autocomplete="off" placeholder="Ex: Av. Paulista, S√£o Paulo" />

      <div class="botoes">
        <button type="button" onclick="usarLocalizacao()">üìç Usar localiza√ß√£o atual</button>
        <button type="submit">üöó Calcular corrida</button>
        <button type="button" id="botaoSolicitar" style="display:none;" onclick="solicitarCorrida()">‚úÖ Solicitar corrida</button>
        <button type="button" id="botaoLimpar" style="display:none;" onclick="limparCampos()">üßπ Limpar campos</button>
      </div>

      <div class="botoes">
        <button type="button" id="botaoCancelar" style="display:none;" onclick="cancelarCorrida()">‚ùå Cancelar corrida</button>
        <button type="button" id="botaoFinalizar" style="display:none;" onclick="finalizarCorrida()">‚úÖ Finalizar corrida</button>
      </div>
    </form>

    <div id="mapaGoogle"></div>
    <div id="resultadoCorrida" role="region" aria-live="polite"></div>
    <section id="listaMotoristas" aria-label="Escolha de motorista"></section>
  </main>

  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyDZKV7Gpy1VCSMxVW__w3PDCyepwJ7Vv6c",
      authDomain: "viasimples-9d340.firebaseapp.com",
      projectId: "viasimples-9d340",
      storageBucket: "viasimples-9d340.appspot.com",
      messagingSenderId: "372389283187",
      appId: "1:372389283187:web:139f81f5224bb0958e7106"
    };
    firebase.initializeApp(firebaseConfig);
    window.db = firebase.firestore();
  </script>

  <!-- Simulador com c√°lculo real via Google Maps -->
  <script>
    let mapa;
    let directionsService;
    let directionsRenderer;
    let autocompleteOrigem;
    let autocompleteDestino;

    function initMap() {
      mapa = new google.maps.Map(document.getElementById("mapaGoogle"), {
        center: { lat: -23.5505, lng: -46.6333 },
        zoom: 13,
      });

      directionsService = new google.maps.DirectionsService();
      directionsRenderer = new google.maps.DirectionsRenderer();
      directionsRenderer.setMap(mapa);

      autocompleteOrigem = new google.maps.places.Autocomplete(document.getElementById("origem"));
      autocompleteDestino = new google.maps.places.Autocomplete(document.getElementById("destino"));
    }
    window.initMap = initMap;

    function usarLocalizacao() {
      if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(
          (posicao) => {
            const { latitude, longitude } = posicao.coords;
            document.getElementById("origem").value = `${latitude}, ${longitude}`;
          },
          (erro) => {
            alert("N√£o foi poss√≠vel obter sua localiza√ß√£o.");
            console.error("Erro de geolocaliza√ß√£o:", erro);
          }
        );
      } else {
        alert("Geolocaliza√ß√£o n√£o √© suportada neste navegador.");
      }
    }

    async function calcularCorrida() {
      const origem = document.getElementById("origem").value;
      const destino = document.getElementById("destino").value;

      if (!origem || !destino) {
        alert("Preencha origem e destino.");
        return;
      }

      try {
        const resultado = await directionsService.route({
          origin: origem,
          destination: destino,
          travelMode: google.maps.TravelMode.DRIVING,
        });

        directionsRenderer.setDirections(resultado);

        const rota = resultado.routes[0].legs[0];
        const distanciaKm = rota.distance.value / 1000;
        const duracaoTexto = rota.duration.text;

        const doc = await window.db.collection("configuracao").doc("valores").get();
        if (!doc.exists) {
          alert("Configura√ß√£o de valores n√£o encontrada.");
          return;
        }

        const dados = doc.data();
        const taxaMinima = parseFloat(dados.taxaMinima) || 0;
        const valorPorKm = parseFloat(dados.valorPorKm) || 0;
        const valorCorrida = Math.max(taxaMinima, distanciaKm * valorPorKm);

        document.getElementById("resultadoCorrida").textContent =
          `Dist√¢ncia: ${distanciaKm.toFixed(2)} km ‚Ä¢ Tempo estimado: ${duracaoTexto} ‚Ä¢ Valor estimado: R$ ${valorCorrida.toFixed(2)}`;
      } catch (erro) {
        console.error("Erro ao calcular rota:", erro);
        alert("N√£o foi poss√≠vel calcular a rota.");
      }
    }
  </script>

  <!-- Script principal do simulador -->
  <script src="03-simulador-script.js" defer></script>

  <!-- Google Maps API com Places e Directions -->
  <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCVB5urWdkPwjezcC6aMAPOZft9oZMyaUQ&libraries=places&callback=initMap&loading=async" async defer></script>
</body>
</html>
