<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Painel do Motorista</title>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
  <style>
    :root {
      --cor-principal: #FFD600;
      --cor-hover: #FFC400;
      --cor-fundo: #f4f6f8;
      --cor-texto: #333;
      --cor-secundaria: #666;
      --fonte: 'Segoe UI', 'Roboto', sans-serif;
    }

    body {
      font-family: var(--fonte);
      background-color: var(--cor-fundo);
      padding: 20px;
      display: flex;
      flex-direction: column;
      align-items: center;
    }

    h1 {
      font-size: 24px;
      color: var(--cor-texto);
      margin-bottom: 20px;
      text-align: center;
    }

    .painel {
      width: 100%;
      max-width: 800px;
      display: flex;
      flex-direction: column;
      gap: 16px;
    }

    .motorista {
      background-color: #fff;
      padding: 16px;
      border-radius: 10px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.05);
      border-left: 5px solid var(--cor-principal);
      position: relative;
    }

    .motorista-id {
      position: absolute;
      top: 16px;
      left: 16px;
      font-size: 13px;
      color: var(--cor-secundaria);
      font-weight: bold;
    }

    .motorista h2 {
      font-size: 20px;
      margin-bottom: 8px;
      color: var(--cor-texto);
      text-align: center;
    }

    .motorista p {
      font-size: 15px;
      color: var(--cor-secundaria);
      margin: 4px 0;
      text-align: center;
    }

    .botao-container {
      display: flex;
      justify-content: center;
      gap: 10px;
      margin-top: 12px;
      flex-wrap: wrap;
    }

    .motorista button {
      padding: 10px 20px;
      font-size: 14px;
      font-weight: bold;
      border: none;
      border-radius: 6px;
      background-color: var(--cor-principal);
      color: #000;
      cursor: pointer;
      transition: background-color 0.3s ease;
      width: 100%;
      max-width: 300px;
    }

    .motorista button:hover {
      background-color: var(--cor-hover);
    }

    .filtro-corridas {
      background-color: #fff;
      padding: 16px;
      border-radius: 10px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.05);
      margin-top: 20px;
    }

    .filtro-corridas h2 {
      text-align: center;
      margin-bottom: 12px;
    }

    .filtro-corridas label {
      margin: 0 8px;
    }

    .filtro-corridas input {
      padding: 6px;
      font-size: 14px;
    }

    .filtro-corridas button {
      padding: 8px 16px;
      font-size: 14px;
      font-weight: bold;
      background-color: var(--cor-principal);
      border: none;
      border-radius: 6px;
      cursor: pointer;
    }

    .filtro-corridas button:hover {
      background-color: var(--cor-hover);
    }
  </style>
</head>

<body>
  <h1>üöñ Painel do Motorista</h1>

  <div class="painel" id="painelMotoristas">Carregando dados...</div>
  <div class="painel" id="corridaAtual"></div>

  <div class="filtro-corridas painel">
    <h2>üìÖ Hist√≥rico de Corridas</h2>
    <div style="display:flex; flex-wrap:wrap; gap:12px; justify-content:center; margin-bottom:12px;">
      <label>De: <input type="date" id="dataInicio"></label>
      <label>At√©: <input type="date" id="dataFim"></label>
      <button onclick="filtrarCorridas()">üîç Buscar</button>
    </div>
    <div id="listaCorridas"></div>
  </div>
  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyDZKV7Gpy1VCSMxVW__w3PDCyepwJ7Vv6c",
      authDomain: "viasimples-9d340.firebaseapp.com",
      projectId: "viasimples-9d340",
      storageBucket: "viasimples-9d340.appspot.com",
      messagingSenderId: "372389283187",
      appId: "1:372389283187:web:139f81f5224bb0958e7106"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    const painel = document.getElementById("painelMotoristas");
    const corridaAtual = document.getElementById("corridaAtual");

    const usuario = localStorage.getItem("usuario");
    let motoristaId = localStorage.getItem("motoristaId");

    if (usuario !== "admin" && usuario !== "motorista") {
      document.body.innerHTML = `
        <main style="text-align:center; padding:60px; font-family:sans-serif;">
          <h2>üîí Acesso restrito</h2>
          <p>Voc√™ precisa estar autenticado para visualizar esta p√°gina.</p>
          <p>Redirecionando para login...</p>
        </main>
      `;
      setTimeout(() => window.location.href = "00-login-admin.html", 2000);
    }

    async function carregarPainel() {
      painel.innerHTML = "";

      try {
        if (usuario === "motorista") {
          if (!motoristaId) {
            // Buscar motorista pelo e-mail autenticado (exemplo)
            const email = localStorage.getItem("email");
            if (email) {
              const snapshot = await db.collection("motoristas").where("email", "==", email).limit(1).get();
              if (!snapshot.empty) {
                motoristaId = snapshot.docs[0].id;
                localStorage.setItem("motoristaId", motoristaId);
              }
            }
          }

          if (!motoristaId) {
            painel.innerHTML = "<p>Motorista n√£o identificado.</p>";
            return;
          }

          const doc = await db.collection("motoristas").doc(motoristaId).get();
          if (!doc.exists) {
            painel.innerHTML = "<p>Motorista n√£o encontrado.</p>";
            return;
          }

          renderizarMotorista(doc);
          escutarCorridaEmTempoReal(motoristaId);
        } else if (usuario === "admin") {
          const lista = await db.collection("motoristas").get();
          if (lista.empty) {
            painel.innerHTML = "<p>Nenhum motorista cadastrado.</p>";
            return;
          }
          lista.forEach(doc => renderizarMotorista(doc));
        }
      } catch (error) {
        console.error("Erro ao carregar motoristas:", error);
        painel.innerHTML = "<p>Erro ao acessar os dados.</p>";
      }
    }

    function renderizarMotorista(doc) {
      const m = doc.data();
      const ref = doc.ref;
      const id = doc.id;

      const container = document.createElement("div");
      container.className = "motorista";

      container.innerHTML = `
        <div class="motorista-id">ID: ${id}</div>
        <h2>${m.nome}</h2>
        <p>Status: ${m.ativo ? "‚úÖ Ativo" : "‚ùå Inativo"}</p>
        <p>Situa√ß√£o: ${
          !m.ativo ? "üîí Bloqueado" :
          m.statusAtual === "em_servico" ? "üü° Em servi√ßo" :
          m.statusAtual === "aguardando" ? "üü¢ Aguardando corrida" :
          "üî¥ Desligado"
        }</p>
      `;

      if (m.ativo && (usuario === "admin" || (usuario === "motorista" && motoristaId === id))) {
        const botaoContainer = document.createElement("div");
        botaoContainer.className = "botao-container";

        const botao = document.createElement("button");
        botao.textContent = m.statusAtual === "desligado" ? "üîå Ligar" : "‚õî Desligar";
        botao.onclick = async () => {
          const novoStatus = m.statusAtual === "desligado" ? "aguardando" : "desligado";
          await ref.update({ statusAtual: novoStatus });
        };

        botaoContainer.appendChild(botao);
        container.appendChild(botaoContainer);
      }

      painel.appendChild(container);
    }

    function escutarCorridaEmTempoReal(motoristaId) {
  db.collection("corridas")
    .where("motoristaId", "==", motoristaId)
    .orderBy("inicio", "desc")
    .limit(1)
    .onSnapshot(snapshot => {
      corridaAtual.innerHTML = "";

      if (snapshot.empty) return;

      const doc = snapshot.docs[0];
      const corrida = doc.data();

      const div = document.createElement("div");
      div.className = "motorista";

      if (corrida.status === "cancelada") {
        div.innerHTML = `
          <h2 style="color:red;">üö´ CORRIDA CANCELADA PELO USU√ÅRIO</h2>
          <p>Passageiro: ${corrida.passageiro || "N/A"}</p>
          <p>Origem: ${corrida.origem}</p>
          <p>Destino: ${corrida.destino}</p>
          <p>Cancelada em: ${new Date(corrida.fim.toDate()).toLocaleString()}</p>
        `;
      } else if (corrida.status === "finalizada") {
        div.innerHTML = `
          <h2 style="color:green;">‚úÖ CORRIDA FINALIZADA</h2>
          <p>Passageiro: ${corrida.passageiro || "N/A"}</p>
          <p>Origem: ${corrida.origem}</p>
          <p>Destino: ${corrida.destino}</p>
          <p>Finalizada em: ${new Date(corrida.fim.toDate()).toLocaleString()}</p>
        `;
      } else if (corrida.status === "em_andamento") {
        div.innerHTML = `
          <h2>üöï Corrida em andamento</h2>
          <p>Passageiro: ${corrida.passageiro || "N/A"}</p>
          <p>Telefone: ${corrida.telefone || "N/A"}</p>
          <p>Origem: ${corrida.origem}</p>
          <p>Destino: ${corrida.destino}</p>
          <p>In√≠cio: ${new Date(corrida.inicio.toDate()).toLocaleString()}</p>
          <p>Status: ${corrida.status}</p>
          <div class="botao-container">
            <button onclick="finalizarCorrida('${doc.id}', '${corrida.motoristaId}')">‚úÖ Finalizar</button>
            <button onclick="cancelarCorrida('${doc.id}', '${corrida.motoristaId}')">‚ùå Cancelar</button>
          </div>
        `;
      }

      corridaAtual.appendChild(div);
    });
}



    async function finalizarCorrida(id, motoristaRefId) {
      await db.collection("corridas").doc(id).update({
        status: "finalizada",
        fim: new Date()
      });

      if (motoristaRefId) {
        await db.collection("motoristas").doc(motoristaRefId).update({
          statusAtual: "aguardando"
        });
      }

      filtrarCorridas();
    }

    async function cancelarCorrida(id, motoristaRefId) {
      await db.collection("corridas").doc(id).update({
        status: "cancelada",
        fim: new Date()
      });

      if (motoristaRefId) {
        await db.collection("motoristas").doc(motoristaRefId).update({
          statusAtual: "aguardando"
        });
      }

      filtrarCorridas();
    }

    async function filtrarCorridas() {
      const lista = document.getElementById("listaCorridas");
      lista.innerHTML = "üîÑ Buscando corridas...";

      const dataInicioInput = document.getElementById("dataInicio").value;
      const dataFimInput = document.getElementById("dataFim").value;

      if (!dataInicioInput || !dataFimInput) {
        alert("Por favor, selecione as datas de in√≠cio e fim.");
        return;
      }

      const inicio = new Date(dataInicioInput);
      const fim = new Date(dataFimInput);
      fim.setHours(23, 59, 59, 999);

      let query = db.collection("corridas")
        .where("inicio", ">=", inicio)
        .where("inicio", "<=", fim)
        .orderBy("inicio", "desc");

      if (usuario === "motorista" && motoristaId) {
        query = query.where("motoristaId", "==", motoristaId);
      }

      const snapshot = await query.get();
      lista.innerHTML = "";
	  
	  if (!motoristaId) {
  const email = localStorage.getItem("email");
  const snapshot = await db.collection("motoristas").where("email", "==", email).limit(1).get();
  if (!snapshot.empty) {
    motoristaId = snapshot.docs[0].id;
    localStorage.setItem("motoristaId", motoristaId);
  }
}


      if (snapshot.empty) {
        lista.innerHTML = "<p style='text-align:center;'>Nenhuma corrida encontrada nesse per√≠odo.</p>";
        return;
      }

      snapshot.forEach(doc => {
        const c = doc.data();
        const item = document.createElement("div");
        item.className = "motorista";
        item.innerHTML = `
          <h2>üóìÔ∏è ${new Date(c.inicio.toDate()).toLocaleString()}</h2>
          <p>Passageiro: ${c.passageiro || "N/A"}</p>
          <p>Telefone: ${c.telefone || "N/A"}</p>
          <p>Origem: ${c.origem}</p>
          <p>Destino: ${c.destino}</p>
          <p>Status: ${c.status}</p>
          ${
            c.status === "em_andamento"
              ? `<div class="botao-container">
                  <button onclick="finalizarCorrida('${doc.id}', '${c.motoristaId}')">‚úÖ Finalizar</button>
                  <button onclick="cancelarCorrida('${doc.id}', '${c.motoristaId}')">‚ùå Cancelar</button>
                </div>`
              : ""
          }
        `;
        lista.appendChild(item);
      });
    }

    carregarPainel();
  </script>
</body>
</html>
